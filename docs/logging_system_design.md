# سیستم لاگ‌گیری هوشمند CV123

## 📋 مفهوم کلی

سیستم لاگ‌گیری هوشمند CV123 یک راه‌حل جامع برای ثبت، مدیریت و نمایش تمامی فعالیت‌های سیستم است که به صورت خودکار تمام اعمال کاربران، خطاها، و رویدادهای سیستم را با جزئیات کامل ثبت می‌کند.

## 🎯 اهداف اصلی

### 1. **ثبت جامع فعالیت‌ها:**
- تمام عملیات دیتابیس (INSERT, UPDATE, DELETE, SELECT)
- درخواست‌های HTTP (GET, POST, PUT, DELETE)
- خطاهای PHP و سیستم
- فعالیت‌های کاربران (ورود، خروج، تغییرات)
- استفاده از APIهای خارجی (SMS, OpenAI)

### 2. **مدیریت هوشمند فایل‌ها:**
- تقسیم‌بندی ترکیبی: بر اساس روز + تعداد رکورد
- فایل جدید هر روز یا هر N رکورد (قابل تنظیم در تنظیمات عمومی)
- فشرده‌سازی فایل‌های قدیمی
- حذف خودکار لاگ‌های قدیمی‌تر از مدت تعیین شده

### 2.1. **قوانین ایجاد فایل جدید:**
1. **تغییر روز:** هر روز فایل جدید (حتی اگر ۱ لاگ باشد)
2. **حد تعداد رکورد:** پس از رسیدن به حد تنظیم شده (پیش‌فرض: ۱۰۰۰)
3. **حد حجم فایل:** اگر حجم فایل به حد مشخص رسد (پیش‌فرض: ۵MB)

### 2.2. **قالب نام‌گذاری:**
```
logs/app_YYYY-MM-DD_XXX.json
مثال: 
- logs/app_2025-09-05_001.json (اولین فایل روز)
- logs/app_2025-09-05_002.json (بعد از ۱۰۰۰ رکورد)
- logs/app_2025-09-05_003.json (بعد از ۱۰۰۰ رکورد دیگر)
```

### 3. **رابط کاربری پیشرفته:**
- نمایش لاگ‌ها با رنگ‌بندی
- جستجو و فیلتر پیشرفته
- نمایش جدولی قابل مرتب‌سازی
- صدور گزارش

## 🏗️ معماری سیستم

### ساختار فایل‌ها:
```
logs/
├── system/                     # لاگ‌های سیستمی
│   ├── 2025-09-05_01.json     # لاگ ساعت 01:00-02:00
│   ├── 2025-09-05_02.json
│   └── ...
├── database/                   # لاگ‌های دیتابیس
│   ├── 2025-09-05_01.json
│   └── ...
├── api/                       # لاگ‌های API
│   ├── 2025-09-05_01.json
│   └── ...
├── errors/                    # لاگ‌های خطا
│   ├── 2025-09-05_01.json
│   └── ...
└── archive/                   # آرشیو فایل‌های فشرده
    ├── system_2025-09-01.zip
    └── ...
```

### ساختار JSON لاگ:
```json
{
    "timestamp": "2025-09-05 14:30:25.123",
    "level": "info|warning|error|debug",
    "category": "system|database|api|auth|sms|ai",
    "user_id": 123,
    "user_ip": "192.168.1.100",
    "session_id": "abc123...",
    "message": "پیام فارسی",
    "message_en": "English message",
    "context": {
        "action": "user_login",
        "table": "users",
        "affected_rows": 1,
        "query_time": 0.045,
        "memory_usage": "2.5MB"
    },
    "request_data": {
        "method": "POST",
        "uri": "/admin/login",
        "user_agent": "Mozilla/5.0...",
        "referer": "http://localhost/cv123.ir/admin"
    },
    "stack_trace": null
}
```

## 📊 سطوح لاگ

### 1. **DEBUG** 🔍
- جزئیات کامل اجرای کد
- متغیرهای مهم
- مسیر اجرای برنامه

### 2. **INFO** ℹ️
- عملیات عادی سیستم
- ورود/خروج کاربران
- عملیات CRUD موفق

### 3. **WARNING** ⚠️
- عملیات مشکوک
- استفاده غیرمعمول از منابع
- تلاش‌های ناموفق

### 4. **ERROR** ❌
- خطاهای PHP
- خطاهای دیتابیس
- خطاهای API

### 5. **CRITICAL** 🚨
- خطاهای سیستمی جدی
- نقض امنیتی
- خرابی سرور

## 🎨 رنگ‌بندی رابط کاربری

| سطح | رنگ | نماد |
|------|-----|------|
| DEBUG | آبی (#007bff) | 🔍 |
| INFO | سبز (#28a745) | ℹ️ |
| WARNING | نارنجی (#ffc107) | ⚠️ |
| ERROR | قرمز (#dc3545) | ❌ |
| CRITICAL | قرمز تیره (#721c24) | 🚨 |

## 🔧 نحوه استفاده

### ساده‌ترین استفاده:
```php
Logger::info('کاربر وارد شد', ['user_id' => 123]);
Logger::error('خطا در اتصال به دیتابیس', ['error' => $e->getMessage()]);
```

### استفاده پیشرفته:
```php
Logger::database()
    ->table('users')
    ->action('INSERT')
    ->user(123)
    ->log('کاربر جدید ثبت شد', $userData);
```

### ثبت خودکار عملیات دیتابیس:
```php
// در کلاس Database
public function query($sql, $params = []) {
    $startTime = microtime(true);
    
    try {
        $result = parent::query($sql, $params);
        
        Logger::database()
            ->query($sql)
            ->params($params)
            ->executionTime(microtime(true) - $startTime)
            ->success('عملیات دیتابیس موفق');
            
        return $result;
    } catch (Exception $e) {
        Logger::database()
            ->query($sql)
            ->params($params)
            ->error('خطا در عملیات دیتابیس: ' . $e->getMessage());
        throw $e;
    }
}
```

## 🖥️ رابط کاربری مدیریت

### صفحه اصلی لاگ‌ها:
- **نمایش زنده:** آخرین 50 لاگ با بروزرسانی خودکار
- **فیلتر زمانی:** انتخاب بازه زمانی
- **فیلتر سطح:** نمایش لاگ‌های خاص
- **جستجو:** جستجو در متن پیام‌ها

### قابلیت‌های تعاملی:
- **کلیک روی لاگ:** نمایش جزئیات کامل
- **کپی به کلیپ‌بورد:** کپی سریع اطلاعات
- **صدور گزارش:** خروجی PDF/Excel
- **نمایش نمودار:** آمار لاگ‌ها

### فیلترهای پیشرفته:
- کاربر مشخص
- IP مشخص
- دامنه زمانی
- نوع عملیات
- جدول دیتابیس

## 📈 آمارگیری و گزارش‌گیری

### آمارهای اصلی:
- تعداد لاگ‌ها در هر ساعت
- فعالیت کاربران
- خطاهای پرتکرار
- عملیات پرهزینه دیتابیس

### گزارش‌های خودکار:
- گزارش روزانه خطاها
- گزارش هفتگی فعالیت
- هشدار برای فعالیت‌های مشکوک

## 🔐 امنیت و حریم خصوصی

### حفاظت از اطلاعات حساس:
- رمزهای عبور هرگز لاگ نمی‌شوند
- اطلاعات کارت اعتباری فیلتر می‌شوند
- داده‌های شخصی ماسک می‌شوند

### دسترسی محدود:
- فقط مدیران سیستم دسترسی دارند
- ثبت تمام دسترسی‌ها به خود لاگ‌ها
- رمزگذاری فایل‌های آرشیو

## ⚙️ تنظیمات سیستم

### تنظیمات پایه:
```php
'logging' => [
    'enabled' => true,
    'level' => 'info', // حداقل سطح لاگ
    'rotate_hours' => 1, // چرخش فایل هر ساعت
    'keep_days' => 30, // نگهداری 30 روز
    'max_file_size' => '50MB',
    'compress_after_days' => 7
]
```

### تنظیمات پیشرفته:
- فیلتر کلمات حساس
- محدودیت حافظه
- تنظیم فرمت زمان
- انتخاب timezone

## 🚀 پیاده‌سازی مرحله‌ای

### مرحله 1: هسته اصلی
- کلاس Logger اصلی
- سیستم چرخش فایل
- فرمت JSON

### مرحله 2: ادغام با سیستم
- ثبت خودکار عملیات دیتابیس
- ثبت درخواست‌های HTTP
- ثبت خطاها

### مرحله 3: رابط کاربری
- صفحه نمایش لاگ‌ها با طراحی مدرن Bootstrap 5
- سیستم فیلتر پیشرفته (تاریخ، سطح، دسته‌بندی، متن)
- امکان جستجوی پیشرفته
- داشبورد آماری با کارت‌های اطلاعاتی
- سیستم صفحه‌بندی لاگ‌ها
- مدیریت آسان با رابط کاربری بصری

### مرحله 4: ویژگی‌های پیشرفته
- آمارگیری و نمودارهای تحلیلی
- گزارش‌گیری با امکان دانلود (JSON، CSV)
- هشدارها و اطلاع‌رسانی خودکار
- مدیریت پاکسازی لاگ‌های قدیمی

## 💡 مزایای این طراحی

### 1. **عملکرد بهینه:**
- ثبت غیرهمزمان لاگ‌ها
- فشرده‌سازی فایل‌های قدیمی
- ایندکس‌گذاری برای جستجوی سریع

### 2. **مقیاس‌پذیری:**
- پشتیبانی از میلیون‌ها لاگ
- توزیع بار روی فایل‌های مختلف
- امکان استفاده از شبکه CDN

### 3. **قابلیت اطمینان:**
- بکاپ خودکار
- بازیابی در صورت خرابی
- تست‌های خودکار

### 4. **سهولت استفاده:**
- API ساده و قابل فهم
- مستندسازی کامل
- نمونه‌های کاری

---

## ✅ وضعیت پیاده‌سازی

### 🎉 تکمیل شده (2025-01-05)

تمام اجزای اصلی سیستم لاگ‌گیری با موفقیت پیاده‌سازی و تست شده‌اند:

### 📊 آمار پیاده‌سازی:
- **فایل‌های ایجاد شده:** 3
- **کلاس‌های اصلی:** 2 (Logger.php, Database.php)
- **تنظیمات دیتابیس:** 5 تنظیمات جدید
- **خطوط کد:** 700+ خط
- **سطوح لاگ:** 5 (SUCCESS, INFO, WARNING, ERROR, DEBUG)
- **دسته‌های لاگ:** 7 (DATABASE, API, SYSTEM, AUTH, SMS, AI, USER)

### 📝 ویژگی‌های پیاده‌سازی‌شده:

#### سیستم لاگ‌گیری هسته:
- ✅ کلاس Logger با متدهای متنوع (info, error, warning, success, debug)
- ✅ دسته‌بندی‌های تخصصی (database, api, auth, sms, ai, user, system)
- ✅ مدیریت هوشمند فایل‌ها (ایجاد فایل جدید برای هر روز)
- ✅ ذخیره‌سازی بهینه در فرمت JSON با ساختار استاندارد
- ✅ استفاده از transaction برای ثبت همزمان چندین لاگ

#### رابط کاربری مدیریت لاگ‌ها:
- ✅ داشبورد مدیریتی با کارت‌های آماری
- ✅ جدول نمایش لاگ‌ها با رنگ‌بندی هوشمند
- ✅ فیلترهای پیشرفته (تاریخ، سطح، دسته، متن)
- ✅ مدیریت پاکسازی لاگ‌های قدیمی
- ✅ امکان دانلود لاگ‌ها
- ✅ طراحی واکنش‌گرا (ریسپانسیو) برای تمام دستگاه‌ها

#### ادغام با سیستم:
- ✅ ثبت خودکار خطاها در try/catch
- ✅ لاگ‌گیری خودکار از عملیات دیتابیس
- ✅ لاگ‌گیری درخواست‌های API خارجی
- ✅ ثبت فعالیت‌های کاربران

### 🚀 قابلیت‌های آینده:

- 🟡 آمارها و نمودارهای پیشرفته
- 🟡 سیستم هشدار ایمیل/پیامک برای خطاهای بحرانی
- 🟡 یکپارچه‌سازی با سیستم مانیتورینگ
- 🟡 پنل تحلیل رفتار کاربران

برای راهنمای استفاده از رابط کاربری مدیریت لاگ‌ها، به مستند [راهنمای صفحه مدیریت لاگ‌های سیستم](admin-logs.md) مراجعه کنید.

#### ✅ **کلاس Logger هوشمند:**
```php
// نحوه استفاده
Logger::info('پیام فارسی', 'English message', ['context' => 'data']);
Logger::database('عملیات دیتابیس', 'Database operation');
Logger::api('درخواست API', 'API request');
Logger::error('خطا رخ داد', 'Error occurred');
```

#### ✅ **فایل‌های JSON با ساختار کامل:**
```json
{
    "id": "log_68ba1a50eac8a6.03329105",
    "timestamp": "2025-01-05 02:31:36",
    "level": "INFO",
    "category": "SYSTEM",
    "user_id": 1,
    "username": "test_user",
    "session_id": "5b83e96592e47e551567826b4f1cdd49",
    "ip_address": "127.0.0.1",
    "message_fa": "پیام فارسی",
    "message_en": "English message",
    "context": {
        "file": "Controller.php",
        "line": 42,
        "function": "processData",
        "memory_usage": 2097152
    },
    "request_id": "req_68ba1a50eac8e6.38991741"
}
```

#### ✅ **تنظیمات دیتابیس:**
- `log_enabled`: فعال/غیرفعال کردن سیستم
- `log_max_records_per_file`: حداکثر رکورد در هر فایل (1000)
- `log_max_file_size_mb`: حداکثر حجم فایل (5 مگابایت)
- `log_retention_days`: مدت نگهداری لاگ‌ها (30 روز)
- `log_debug_mode`: حالت دیباگ

#### ✅ **ویژگی‌های امنیتی:**
- مخفی‌سازی خودکار رمزهای عبور و کلیدهای API
- ردیابی کامل session و کاربر
- قفل‌گذاری فایل برای جلوگیری از تداخل

#### ✅ **بهینه‌سازی عملکرد:**
- تقسیم هوشمند فایل‌ها
- پاکسازی خودکار فایل‌های قدیمی
- استفاده از تنظیمات حافظه‌ای

### 🧪 تست‌های انجام‌شده:
- ✅ ثبت انواع مختلف لاگ
- ✅ تست تحت بار (10+ لاگ همزمان)
- ✅ تست مخفی‌سازی اطلاعات حساس
- ✅ تست تقسیم فایل‌ها
- ✅ تست آمارگیری و گزارش‌گیری

### 📈 نتایج تست:
- **تولید لاگ‌ها:** 26 لاگ در 1 فایل
- **حجم فایل:** 0.02 مگابایت
- **توزیع سطوح:** INFO(20), ERROR(4), SUCCESS(1), WARNING(1)
- **توزیع دسته‌ها:** SYSTEM(17), DATABASE(2), API(2), AUTH(2), SMS(1), AI(1), USER(1)

### 📁 فایل‌های ایجاد شده:
```
/app/helpers/Logger.php       (کلاس اصلی لاگ‌گیری)
/app/helpers/Database.php     (ادغام لاگ با دیتابیس)
/test_logger_complete.php     (تست کامل سیستم)
/logs/app_YYYY-MM-DD_XXX.json (فایل‌های لاگ)
/logs/.gitignore             (حفاظت از لاگ‌ها در گیت)
```

---

## 🚀 مراحل بعدی (اختیاری)

### 1. **رابط مدیریت وب:**
- صفحه نمایش لاگ‌ها
- جستجو و فیلتر بر اساس سطح، دسته، تاریخ
- گراف‌های آماری
- حذف و دانلود لاگ‌ها

### 2. **هشدارهای هوشمند:**
- ارسال ایمیل در صورت خطاهای مهم
- نوتیفیکیشن در داشبورد
- گزارش‌های دوره‌ای

### 3. **ادغام بیشتر:**
- لاگ‌گیری درخواست‌های AJAX
- لاگ‌گیری تغییرات دیتابیس
- لاگ‌گیری فایل‌های آپلود

---

**آیا با این طراحی موافقید؟ کدام بخش را می‌خواهید اصلاح یا تکمیل کنم؟**
